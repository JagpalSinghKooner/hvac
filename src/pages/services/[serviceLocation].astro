---
import { getEntry, getCollection, type CollectionEntry } from 'astro:content';
import ServicePageLayout from '@/layouts/ServicePageLayout.astro';
import { getServiceCityLinks } from '@/utils/getInternalLinks';

export async function getStaticPaths() {
  const serviceCityEntries = await getCollection('service-city');

  const paths = serviceCityEntries.map((entry) => {
    const urlSlug = `${entry.data.serviceSlug}-${entry.data.locationSlug}-on`;

    return {
      params: { serviceLocation: urlSlug },
      props: {
        serviceCityEntry: entry,
      },
    };
  });

  return paths;
}

type Props = {
  serviceCityEntry: CollectionEntry<'service-city'>;
};

const { serviceCityEntry } = Astro.props;
const serviceCityData = serviceCityEntry.data;

// Get business profile
const businessProfile = await getEntry('business', 'profile');
if (!businessProfile) {
  throw new Error('Business profile not found');
}
const business = businessProfile.data;

// Get parent service data
const parentService = await getEntry('services', serviceCityData.serviceSlug);
if (!parentService) {
  throw new Error(`Parent service not found: ${serviceCityData.serviceSlug}`);
}
const serviceData = parentService.data;

// Get parent location data
const parentLocation = await getEntry('locations', serviceCityData.locationSlug);
if (!parentLocation) {
  throw new Error(`Parent location not found: ${serviceCityData.locationSlug}`);
}
const locationData = parentLocation.data;

// Get FAQs filtered by service scope
const allFAQs = await getCollection('faqs');
const serviceFAQs = allFAQs
  .filter(
    (faq) =>
      faq.data.status === 'live' &&
      (faq.data.scopes?.includes(`service:${serviceCityData.serviceSlug}`) ||
        faq.data.scopes?.includes('general'))
  )
  .sort((a, b) => {
    if (a.data.priority && !b.data.priority) return -1;
    if (!a.data.priority && b.data.priority) return 1;
    return 0;
  })
  .slice(0, 6)
  .map((faq) => ({
    question: faq.data.question,
    answer: faq.data.answer,
  }));

// Get reviews - try to get reviews for this service
const allReviews = await getCollection('reviews');
let filteredReviews = allReviews.filter(
  (review) =>
    review.data.status === 'live' &&
    review.data.workflowStatus === 'published' &&
    review.data.serviceSlug === serviceCityData.serviceSlug
);

// If fewer than 3 service-specific reviews, use all live reviews
if (filteredReviews.length < 3) {
  filteredReviews = allReviews.filter(
    (review) => review.data.status === 'live' && review.data.workflowStatus === 'published'
  );
}

const reviewsToShow = filteredReviews
  .sort((a, b) => {
    if (a.data.priority !== b.data.priority) {
      return a.data.priority - b.data.priority;
    }
    return new Date(b.data.reviewDate).getTime() - new Date(a.data.reviewDate).getTime();
  })
  .slice(0, 9);

// Get related services (same service in other cities)
const relatedServiceCityLinks = await getServiceCityLinks(serviceCityData.serviceSlug);
const relatedServices = relatedServiceCityLinks
  .filter((link) => link.slug !== serviceCityData.locationSlug) // Exclude current location
  .slice(0, 6)
  .map((link) => ({
    title: `${serviceData.title} in ${link.title}`,
    slug: `${serviceCityData.serviceSlug}-${link.slug}-on`,
    description: `Professional ${serviceData.title.toLowerCase()} services in ${link.title}, Ontario.`,
  }));

// Render service-city body content
const { Content } = await serviceCityEntry.render();

// Prepare data for ServicePageLayout with fallback pattern
const benefits =
  serviceCityData.benefits?.map((b) => ({
    title: b.title,
    description: b.description,
    icon: b.icon || 'check',
  })) ||
  serviceData.benefits?.map((b) => ({
    title: b.title,
    description: b.description,
    icon: b.icon || 'check',
  })) ||
  [];

const processSteps =
  serviceCityData.processSteps?.map((ps) => ({
    step: ps.step,
    title: ps.title,
    description: ps.description,
  })) ||
  serviceData.processSteps?.map((ps) => ({
    step: ps.step,
    title: ps.title,
    description: ps.description,
  })) ||
  [];

const savingsData = (() => {
  const savings = serviceCityData.savings || serviceData.savings;
  if (!savings) return undefined;

  return {
    headline: savings.headline,
    description: savings.description,
    bullets: 'bullets' in savings ? savings.bullets : undefined,
    rebateInfo: savings.rebateInfo,
    financingNote: 'financingNote' in savings ? savings.financingNote : undefined,
  };
})();
---

<ServicePageLayout
  pageType="service-city"
  title={serviceCityData.seoTitle}
  description={serviceCityData.seoDescription}
  serviceTitle={serviceCityData.title}
  serviceDescription={serviceCityData.seoDescription}
  category={serviceData.category}
  serviceType={serviceData.title}
  cityName={locationData.title}
  locationSlug={serviceCityData.locationSlug}
  trustOpener={serviceCityData.trustOpener}
  problem={serviceCityData.problem || serviceData.problem}
  solution={serviceCityData.solution || serviceData.solution}
  galleryImages={serviceCityData.galleryImages}
  Content={Content}
  benefits={benefits}
  processSteps={processSteps}
  proof={serviceCityData.proof}
  context={serviceCityData.context}
  savings={savingsData}
  faqs={serviceFAQs}
  reviews={reviewsToShow}
  relatedServices={relatedServices}
  business={business}
/>
