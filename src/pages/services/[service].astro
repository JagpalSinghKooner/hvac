---
import { getCollection, type CollectionEntry, getEntry } from 'astro:content';
import ServicePageLayout from '@/layouts/ServicePageLayout.astro';
import { getRelatedServices } from '@/utils/getInternalLinks';

export async function getStaticPaths() {
  const allServices = await getCollection('services');
  const publishedServices = allServices.filter(
    (service) => service.data.status === 'live' && service.data.workflowStatus === 'published'
  );

  return publishedServices.map((service) => ({
    params: { service: service.slug },
    props: { service },
  }));
}

type Props = {
  service: CollectionEntry<'services'>;
};

const { service } = Astro.props;

const businessProfile = await getEntry('business', 'profile');
if (!businessProfile) {
  throw new Error('Business profile not found');
}
const business = businessProfile.data;

// Get service content
const { Content } = await service.render();

// Get FAQs filtered by this service
const allFaqs = await getCollection('faqs');
const serviceFaqs = allFaqs
  .filter(
    (faq) =>
      faq.data.status === 'live' &&
      faq.data.workflowStatus === 'published' &&
      faq.data.scopes.some((scope) => scope === `service:${service.slug}` || scope === 'general')
  )
  .sort((a, b) => a.data.priority - b.data.priority)
  .slice(0, 6)
  .map((faq) => ({
    question: faq.data.question,
    answer: faq.data.answer,
  }));

// Get reviews filtered by this service
const allReviews = await getCollection('reviews');
const serviceReviews = allReviews
  .filter(
    (review) =>
      review.data.status === 'live' &&
      review.data.workflowStatus === 'published' &&
      review.data.serviceSlug === service.slug
  )
  .sort((a, b) => {
    if (a.data.priority !== b.data.priority) {
      return a.data.priority - b.data.priority;
    }
    return new Date(b.data.reviewDate).getTime() - new Date(a.data.reviewDate).getTime();
  })
  .slice(0, 9);

// If not enough service-specific reviews, get general reviews
const reviewsToShow =
  serviceReviews.length >= 3
    ? serviceReviews
    : allReviews
        .filter(
          (review) =>
            review.data.status === 'live' && review.data.workflowStatus === 'published'
        )
        .sort((a, b) => {
          if (a.data.priority !== b.data.priority) {
            return a.data.priority - b.data.priority;
          }
          return new Date(b.data.reviewDate).getTime() - new Date(a.data.reviewDate).getTime();
        })
        .slice(0, 9);

// Get related services
const relatedServices = await getRelatedServices(
  service.slug,
  service.data.category,
  3
);
---

<ServicePageLayout
  pageType="service"
  title={service.data.seoTitle || `${service.data.title} | ${business.business.legal_name}`}
  description={service.data.seoDescription || service.data.description}
  serviceTitle={service.data.title}
  serviceDescription={service.data.description}
  category={service.data.category}
  serviceType={service.data.serviceType}
  problem={service.data.problem}
  solution={service.data.solution}
  Content={Content}
  benefits={service.data.benefits}
  processSteps={service.data.processSteps}
  savings={service.data.savings}
  faqs={serviceFaqs}
  reviews={reviewsToShow}
  relatedServices={relatedServices}
  business={business}
/>
