---
import { getCollection, type CollectionEntry, getEntry } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import ServiceHeroSection from '@/components/sections/ServiceHeroSection.astro';
import ProblemSection from '@/components/sections/ProblemSection.astro';
import SolutionSection from '@/components/sections/SolutionSection.astro';
import ServiceBenefitsSection from '@/components/sections/ServiceBenefitsSection.astro';
import ServiceProcessSection from '@/components/sections/ServiceProcessSection.astro';
import ServiceSavingsSection from '@/components/sections/ServiceSavingsSection.astro';
import ServiceFAQSection from '@/components/sections/ServiceFAQSection';
import TestimonialsCarousel from '@/components/sections/TestimonialsCarousel';
import RelatedServicesSection from '@/components/sections/RelatedServicesSection.astro';
import FinalCTASection from '@/components/sections/FinalCTASection.astro';
import { getRelatedServices } from '@/utils/getInternalLinks';

export async function getStaticPaths() {
  const allServices = await getCollection('services');
  const publishedServices = allServices.filter(
    (service) => service.data.status === 'live' && service.data.workflowStatus === 'published'
  );

  return publishedServices.map((service) => ({
    params: { service: service.slug },
    props: { service },
  }));
}

type Props = {
  service: CollectionEntry<'services'>;
};

const { service } = Astro.props;

const businessProfile = await getEntry('business', 'profile');
if (!businessProfile) {
  throw new Error('Business profile not found');
}
const business = businessProfile.data;

// Get service content
const { Content } = await service.render();

// Get FAQs filtered by this service
const allFaqs = await getCollection('faqs');
const serviceFaqs = allFaqs
  .filter(
    (faq) =>
      faq.data.status === 'live' &&
      faq.data.workflowStatus === 'published' &&
      faq.data.scopes.some((scope) => scope === `service:${service.slug}` || scope === 'general')
  )
  .sort((a, b) => a.data.priority - b.data.priority)
  .slice(0, 6)
  .map((faq) => ({
    question: faq.data.question,
    answer: faq.data.answer,
  }));

// Get reviews filtered by this service
const allReviews = await getCollection('reviews');
const serviceReviews = allReviews
  .filter(
    (review) =>
      review.data.status === 'live' &&
      review.data.workflowStatus === 'published' &&
      review.data.serviceSlug === service.slug
  )
  .sort((a, b) => {
    if (a.data.priority !== b.data.priority) {
      return a.data.priority - b.data.priority;
    }
    return new Date(b.data.reviewDate).getTime() - new Date(a.data.reviewDate).getTime();
  })
  .slice(0, 9);

// If not enough service-specific reviews, get general reviews
const reviewsToShow =
  serviceReviews.length >= 3
    ? serviceReviews
    : allReviews
        .filter(
          (review) =>
            review.data.status === 'live' && review.data.workflowStatus === 'published'
        )
        .sort((a, b) => {
          if (a.data.priority !== b.data.priority) {
            return a.data.priority - b.data.priority;
          }
          return new Date(b.data.reviewDate).getTime() - new Date(a.data.reviewDate).getTime();
        })
        .slice(0, 9);

// Get related services
const relatedServices = await getRelatedServices(
  service.slug,
  service.data.category,
  3
);
---

<BaseLayout
  title={service.data.seoTitle || `${service.data.title} | ${business.business.legal_name}`}
  description={service.data.seoDescription || service.data.description}
>
  <!-- Service Hero Section -->
  <ServiceHeroSection
    title={service.data.title}
    description={service.data.description}
    category={service.data.category}
    serviceType={service.data.serviceType}
    phoneNumber={business.contact.phone_e164}
    phoneDisplay={business.contact.phone_display}
  />

  <!-- Problem Section (NEW - Phase 6B) -->
  {service.data.problemStatement && (
    <ProblemSection
      headline={service.data.problemStatement.headline}
      description={service.data.problemStatement.description}
      painPoints={service.data.problemStatement.painPoints || []}
    />
  )}

  <!-- Solution Section (NEW - Phase 6B) -->
  {service.data.solutionApproach && (
    <SolutionSection
      headline={service.data.solutionApproach.headline}
      description={service.data.solutionApproach.description}
      differentiators={service.data.solutionApproach.differentiators || []}
    />
  )}

  <!-- Service Content (Markdown) -->
  {Content && (
    <section class="py-16 md:py-20 lg:py-24 bg-background">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
        <div class="max-w-4xl mx-auto prose prose-neutral dark:prose-invert prose-headings:font-bold prose-a:text-primary">
          <Content />
        </div>
      </div>
    </section>
  )}

  <!-- Service Benefits Section (valueProps) -->
  {service.data.valueProps && service.data.valueProps.length > 0 && (
    <ServiceBenefitsSection
      benefits={service.data.valueProps}
      headline="Why Choose Us"
    />
  )}

  <!-- Service Process Section (processSteps) -->
  {service.data.processSteps && service.data.processSteps.length > 0 && (
    <ServiceProcessSection
      steps={service.data.processSteps}
      headline="Our Process"
    />
  )}

  <!-- Service Savings Section -->
  {service.data.savings && (
    <ServiceSavingsSection
      headline={service.data.savings.headline}
      description={service.data.savings.description}
      bullets={service.data.savings.bullets}
      rebateInfo={service.data.savings.rebateInfo}
      financingNote={service.data.savings.financingNote}
    />
  )}

  <!-- Service FAQ Section -->
  {serviceFaqs.length > 0 && (
    <ServiceFAQSection
      client:load
      faqs={serviceFaqs}
      headline="Frequently Asked Questions"
    />
  )}

  <!-- Testimonials -->
  {reviewsToShow.length > 0 && (
    <TestimonialsCarousel
      client:load
      reviews={reviewsToShow}
      googleRating={business.reputation.google_rating}
      googleReviewCount={business.reputation.google_review_count}
    />
  )}

  <!-- Related Services -->
  {relatedServices.length > 0 && (
    <RelatedServicesSection
      services={relatedServices}
      headline="Related Services"
    />
  )}

  <!-- Final CTA -->
  <FinalCTASection />
</BaseLayout>
