---
import { getEntry, getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import HeroSection from '@/components/sections/HeroSection.astro';
import ValuePropsGrid from '@/components/sections/ValuePropsGrid.astro';
import BrandLogoTicker from '@/components/ui/BrandLogoTicker.astro';
import ServiceCategoriesGrid from '@/components/sections/ServiceCategoriesGrid.astro';
import ExpertConsultationSection from '@/components/sections/ExpertConsultationSection.astro';
import ProjectGallerySection from '@/components/sections/ProjectGallerySection.astro';
import TestimonialsCarousel from '@/components/sections/TestimonialsCarousel';
import FamilyStorySection from '@/components/sections/FamilyStorySection.astro';
import ServiceAreaSection from '@/components/sections/ServiceAreaSection.astro';
import FinancingPreviewSection from '@/components/sections/FinancingPreviewSection.astro';
import BlogPreviewSection from '@/components/sections/BlogPreviewSection.astro';
import CertificationsSection from '@/components/sections/CertificationsSection.astro';
import FinalCTASection from '@/components/sections/FinalCTASection.astro';
import StickyPhoneDrawer from '@/components/cta/StickyPhoneDrawer';

const businessProfile = await getEntry('business', 'profile');
if (!businessProfile) {
  throw new Error('Business profile not found');
}
const business = businessProfile.data;

// Fetch installation-related reviews
const allReviews = await getCollection('reviews');
const installationReviews = allReviews
  .filter(
    (review) =>
      review.data.workflowStatus === 'published' &&
      review.data.status === 'live' &&
      (review.data.text.toLowerCase().includes('install') ||
        review.data.serviceSlug.includes('installation'))
  )
  .sort((a, b) => b.data.priority - a.data.priority)
  .slice(0, 9); // Show up to 9 reviews (3 visible at a time on desktop)
---

<BaseLayout
  title={`${business.business.legal_name} | HVAC Services Guelph & Southern Ontario`}
  description={(business as any).copy_blocks.short_description}
>
  <HeroSection />
  <ValuePropsGrid />
  <BrandLogoTicker />
  <ServiceCategoriesGrid />
  <ExpertConsultationSection />
  <ProjectGallerySection />
  <TestimonialsCarousel
    client:load
    reviews={installationReviews}
    googleRating={business.reputation.google_rating}
    googleReviewCount={business.reputation.google_review_count}
  />
  <FamilyStorySection />
  <ServiceAreaSection />
  <FinancingPreviewSection />
  <BlogPreviewSection />
  <CertificationsSection />
  <FinalCTASection />

  <!-- Sticky Phone Drawer (appears when scrolling up) -->
  <StickyPhoneDrawer
    client:load
    phoneDisplay={business.contact.phone_display}
    phoneE164={business.contact.phone_e164}
    email={business.contact.email}
  />
</BaseLayout>
