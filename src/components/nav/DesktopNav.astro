---
import { getEntry } from 'astro:content';
import { ChevronDown, ChevronRight } from 'lucide-react';

const businessProfile = await getEntry('business', 'profile');
if (!businessProfile) {
  throw new Error('Business profile not found');
}
const business = businessProfile.data;

// Get current page path for active state detection
const currentPath = Astro.url.pathname;

// Helper to check if link is active
const isActivePage = (href: string) => {
  const normalizedCurrent = currentPath.replace(/\/$/, '');
  const normalizedHref = href.replace(/\/$/, '');
  return normalizedCurrent === normalizedHref || normalizedCurrent.startsWith(normalizedHref + '/');
};

// Define service category groups for individual dropdowns
const serviceCategoryGroups = [
  {
    name: "Heating",
    key: "heating",
  },
  {
    name: "Cooling",
    key: "cooling",
  },
  {
    name: "Water Heating",
    key: "water_heating",
  },
  {
    name: "Indoor Air Quality",
    key: "iaq",
  },
  {
    name: "Other Services",
    key: "other",
    // Combine commercial and maintenance plans into "Other Services"
    items: [
      ...((business as any).services?.list?.commercial || []),
      ...((business as any).services?.list?.plans || [])
    ]
  }
];
---

<nav class="flex items-center gap-1" aria-label="Primary navigation">
  <!-- Individual Service Category Dropdowns -->
  {serviceCategoryGroups.map((category) => (
    <div class="desktop-dropdown relative">
      <button
        class="dropdown-trigger relative flex items-center gap-1 px-3 py-2 text-sm font-heading font-semibold hover:text-primary transition-colors whitespace-nowrap group"
        aria-haspopup="true"
        aria-expanded="false"
        data-dropdown={category.key}
      >
        {category.name}
        <ChevronDown className="h-3 w-3 transition-transform duration-200 group-hover:rotate-180" />
        <!-- Gradient underline on hover -->
        <span
          class="absolute bottom-0 left-0 right-0 h-0.5 gradient-brand scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left"
          aria-hidden="true"
        ></span>
      </button>

      <div class="dropdown-menu absolute top-full left-0 opacity-0 invisible pointer-events-none bg-background border rounded-lg shadow-lg p-6 mt-2 min-w-[280px] z-[100]">
        <ul class="space-y-2">
          {category.key === 'other'
            ? category.items?.map((service: any) => (
                <li>
                  <a
                    href={`/services/${service.slug}/`}
                    class="text-sm font-body hover:text-primary transition-all duration-200 block py-1.5 px-2 rounded hover:bg-accent group"
                    aria-current={isActivePage(`/services/${service.slug}/`) ? 'page' : undefined}
                  >
                    <span class="flex items-center justify-between gap-2">
                      {service.title}
                      <ChevronRight className="h-3 w-3 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-200" />
                    </span>
                  </a>
                </li>
              ))
            : (business as any).services?.list?.[category.key]?.map((service: any) => (
                <li>
                  <a
                    href={`/services/${service.slug}/`}
                    class="text-sm font-body hover:text-primary transition-all duration-200 block py-1.5 px-2 rounded hover:bg-accent group"
                    aria-current={isActivePage(`/services/${service.slug}/`) ? 'page' : undefined}
                  >
                    <span class="flex items-center justify-between gap-2">
                      {service.title}
                      <ChevronRight className="h-3 w-3 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-200" />
                    </span>
                  </a>
                </li>
              ))
          }
        </ul>
      </div>
    </div>
  ))}

  <!-- Locations Link -->
  <a
    href="/locations/"
    class="relative flex items-center gap-1 px-3 py-2 text-sm font-heading font-semibold hover:text-primary transition-colors whitespace-nowrap group"
    aria-current={isActivePage('/locations/') ? 'page' : undefined}
  >
    Locations
    <!-- Gradient underline on hover -->
    <span
      class="absolute bottom-0 left-0 right-0 h-0.5 gradient-brand scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left"
      aria-hidden="true"
    ></span>
    <!-- Active state indicator -->
    {isActivePage('/locations/') && (
      <span
        class="absolute bottom-0 left-0 right-0 h-0.5 gradient-brand"
        aria-hidden="true"
      ></span>
    )}
  </a>

</nav>

<style>
  .desktop-dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .dropdown-menu:hover {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .desktop-dropdown {
    position: relative;
  }

  .dropdown-menu {
    transition: opacity 150ms ease-in-out,
                visibility 150ms ease-in-out,
                transform 150ms ease-out,
                box-shadow 150ms ease-out;
    transform: translateY(0);
    box-shadow: 0 4px 12px -2px rgba(0, 102, 204, 0.08),
                0 2px 8px -2px rgba(0, 102, 204, 0.04);
  }

  .desktop-dropdown:hover .dropdown-menu {
    transition-delay: 0ms;
  }

  .desktop-dropdown:not(:hover) .dropdown-menu {
    transition: opacity 250ms ease-in-out,
                visibility 250ms ease-in-out,
                transform 150ms ease-out,
                box-shadow 150ms ease-out;
    transition-delay: 0ms;
  }

  /* Hover lift effect */
  .dropdown-menu:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px -4px rgba(0, 102, 204, 0.12),
                0 8px 16px -4px rgba(0, 102, 204, 0.08);
  }

  /* Active page styling */
  [aria-current="page"] {
    color: hsl(var(--primary));
    font-weight: 600;
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .dropdown-menu,
    .desktop-dropdown:hover .dropdown-menu,
    .dropdown-menu:hover,
    .group:hover .transition-transform,
    .group:hover .transition-all {
      transition: none;
    }

    .group:hover svg {
      transform: none;
    }
  }
</style>

<script>
  // Add hover functionality for dropdowns with smart closing
  document.addEventListener('DOMContentLoaded', () => {
    const dropdowns = document.querySelectorAll('.desktop-dropdown');
    let currentlyOpen: HTMLElement | null = null;
    let hideTimeout: ReturnType<typeof setTimeout> | null = null;

    // Function to instantly close a dropdown without delay
    const closeDropdownInstantly = (dropdown: Element) => {
      const trigger = dropdown.querySelector('.dropdown-trigger');
      const menu = dropdown.querySelector('.dropdown-menu');
      if (!trigger || !menu) return;

      menu.classList.remove('opacity-100', 'visible', 'pointer-events-auto');
      menu.classList.add('opacity-0', 'invisible', 'pointer-events-none');
      trigger.setAttribute('aria-expanded', 'false');
    };

    dropdowns.forEach((dropdown) => {
      const trigger = dropdown.querySelector('.dropdown-trigger');
      const menu = dropdown.querySelector('.dropdown-menu');

      if (!trigger || !menu) return;

      const showMenu = () => {
        // Clear any pending hide timeout
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }

        // Instantly close the previously open dropdown (if different)
        if (currentlyOpen && currentlyOpen !== dropdown) {
          closeDropdownInstantly(currentlyOpen);
        }

        // Open this dropdown
        menu.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
        menu.classList.add('opacity-100', 'visible', 'pointer-events-auto');
        trigger.setAttribute('aria-expanded', 'true');
        currentlyOpen = dropdown as HTMLElement;
      };

      const hideMenu = () => {
        hideTimeout = setTimeout(() => {
          menu.classList.remove('opacity-100', 'visible', 'pointer-events-auto');
          menu.classList.add('opacity-0', 'invisible', 'pointer-events-none');
          trigger.setAttribute('aria-expanded', 'false');
          if (currentlyOpen === dropdown) {
            currentlyOpen = null;
          }
        }, 200);
      };

      dropdown.addEventListener('mouseenter', showMenu);
      dropdown.addEventListener('mouseleave', hideMenu);
      menu.addEventListener('mouseenter', () => {
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
      });
      menu.addEventListener('mouseleave', hideMenu);
    });
  });
</script>
