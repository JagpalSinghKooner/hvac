---
/**
 * LocalTrustSignals Component
 *
 * Displays trust-building elements for location pages including:
 * - Years in business
 * - Licensing and certifications
 * - Guarantees and warranties
 *
 * Usage:
 * <LocalTrustSignals location="Guelph" />
 * <LocalTrustSignals variant="compact" />
 */

import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import Section from '@/components/layout/Section.astro';
import Container from '@/components/layout/Container.astro';
import * as Icons from 'lucide-react';
import { getEntry } from 'astro:content';
import { cn } from '@/lib/utils';

interface Props {
  location?: string;              // Optional: city/location name for personalization
  heading?: string;               // Optional: custom heading
  showHeading?: boolean;          // Show default heading (default: true)
  variant?: 'grid' | 'compact';   // Layout variant (default: 'grid')
  class?: string;                 // Optional: custom wrapper classes
}

const {
  location,
  heading = 'Why Trust B.A.P Heating & Cooling?',
  showHeading = true,
  variant = 'grid',
  class: className
} = Astro.props;

// Fetch business profile
const businessProfile = await getEntry('business', 'profile');
if (!businessProfile) {
  throw new Error('Business profile not found');
}

const business = businessProfile.data as any;

// Calculate years in business
const currentYear = new Date().getFullYear();
const yearsInBusiness = currentYear - business.established_year;

// Extract data with defensive checks
const tssaLicense = business.trust_and_compliance?.licenses?.tssa?.numbers?.[0] || '000076639116';
const warrantyStatement = business.warranty_and_guarantees?.warranty_statement || '10-year warranty on parts and labour';
const guaranteeCopy = business.warranty_and_guarantees?.guarantee_primary?.copy || 'You approve the work before we start';
const guaranteePreview = guaranteeCopy.length > 80 ? guaranteeCopy.substring(0, 80) + '...' : guaranteeCopy;

// Build trust signals array
const trustSignals = [
  {
    icon: 'Building2',
    title: `${yearsInBusiness} Years of Service`,
    description: location
      ? `Proudly serving ${location} since ${business.established_year}`
      : `Serving the community since ${business.established_year}`
  },
  {
    icon: 'Shield',
    title: 'TSSA Licensed',
    description: `License #${tssaLicense} - Fully compliant in Ontario`
  },
  {
    icon: 'Award',
    title: 'HRAI Certified',
    description: 'HRAI Member & Heatpump Champion certified'
  },
  {
    icon: 'CheckCircle',
    title: 'BBB Member',
    description: 'Better Business Bureau recognized business'
  },
  {
    icon: 'CheckCircle',
    title: 'No-Surprise Guarantee',
    description: guaranteePreview
  },
  {
    icon: 'Shield',
    title: '10-Year Warranty',
    description: warrantyStatement
  }
];

// Pre-process icons for Astro compatibility (must be done in frontmatter)
const signalsWithIcons = trustSignals.map(signal => ({
  ...signal,
  IconComponent: (Icons as any)[signal.icon] || Icons.CheckCircle
}));
---

<Section padding="lg" class={cn("bg-muted/30", className)}>
  <Container>
    {showHeading && heading && (
      <div class="text-center mb-12">
        <h2 class="text-3xl font-semibold mb-4">{heading}</h2>
      </div>
    )}

    {variant === 'grid' ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {signalsWithIcons.map((signal) => (
          <Card className="text-center h-full flex flex-col">
            <CardHeader>
              <div class="w-12 h-12 rounded-full flex items-center justify-center bg-primary/10 mx-auto mb-4">
                <signal.IconComponent className="h-6 w-6 text-primary" aria-hidden="true" />
              </div>
              <CardTitle className="text-lg">{signal.title}</CardTitle>
            </CardHeader>
            <CardContent className="flex-1">
              <p class="text-sm text-muted-foreground">{signal.description}</p>
            </CardContent>
          </Card>
        ))}
      </div>
    ) : (
      <!-- Compact variant: simpler horizontal layout -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        {signalsWithIcons.map((signal) => (
          <div class="flex flex-col items-center text-center gap-2">
            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-primary/10">
              <signal.IconComponent className="h-5 w-5 text-primary" aria-hidden="true" />
            </div>
            <div>
              <p class="text-sm font-semibold">{signal.title}</p>
            </div>
          </div>
        ))}
      </div>
    )}
  </Container>
</Section>
