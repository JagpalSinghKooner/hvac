---
import { getCollection } from 'astro:content';
import Section from '@/components/layout/Section.astro';
import Container from '@/components/layout/Container.astro';
import ServiceCard from '@/components/cards/ServiceCard.astro';
import { Button } from '@/components/ui/button';
import { ArrowRight } from 'lucide-react';
import { cn } from '@/lib/utils';

// ============================================================================
// TYPE DEFINITIONS
// ============================================================================

interface Service {
  title: string;
  slug: string;
  description: string;
  icon?: string;
  category: 'heating' | 'cooling' | 'iaq' | 'water-heating' | 'commercial' | 'plans';
}

interface Props {
  services?: Service[];              // Optional - auto-fetch if not provided
  heading?: string;                  // Default: "Our Services"
  subheading?: string;               // Optional contextual text
  columns?: 2 | 3 | 4;              // Default: 3
  variant?: 'compact' | 'featured';  // Default: 'compact' - passed to ServiceCard
  limit?: number;                    // Optional - slice services array
  showViewAll?: boolean;             // Default: false - show link to /services
  linkType?: 'standard' | 'location-specific';  // Default: 'standard'
  locationSlug?: string;             // Required when linkType='location-specific'
  categoryFilter?: Service['category'];  // Optional category filter
  class?: string;                    // Custom classes for Section wrapper
}

// ============================================================================
// PROPS DESTRUCTURING WITH DEFAULTS
// ============================================================================

const {
  services: providedServices,
  heading = 'Our Services',
  subheading,
  columns = 3,
  variant = 'compact',
  limit,
  showViewAll = false,
  linkType = 'standard',
  locationSlug,
  categoryFilter,
  class: className
} = Astro.props;

// ============================================================================
// DATA FETCHING LOGIC
// ============================================================================

let displayServices: Service[];

if (providedServices) {
  // Use provided services (assume pre-filtered and sorted)
  displayServices = providedServices;
} else {
  // Auto-fetch from content collection
  const allServices = await getCollection('services');

  // Filter for live and published services only
  const publishedServices = allServices.filter(
    (service) => service.data.status === 'live' && service.data.workflowStatus === 'published'
  );

  // Map to simplified Service interface
  displayServices = publishedServices.map((service) => ({
    title: service.data.title,
    slug: service.slug,
    description: service.data.description,
    icon: service.data.icon,
    category: service.data.category
  }));

  // Sort by priority (priority services first), then by order field (ascending)
  displayServices.sort((a, b) => {
    const aData = publishedServices.find(s => s.slug === a.slug)?.data;
    const bData = publishedServices.find(s => s.slug === b.slug)?.data;

    // Priority services first
    if (aData?.priority && !bData?.priority) return -1;
    if (!aData?.priority && bData?.priority) return 1;

    // Then by order number (undefined treated as 999)
    const aOrder = aData?.order ?? 999;
    const bOrder = bData?.order ?? 999;
    return aOrder - bOrder;
  });
}

// ============================================================================
// APPLY FILTERS
// ============================================================================

// Apply category filter if specified
if (categoryFilter) {
  displayServices = displayServices.filter(service => service.category === categoryFilter);
}

// Apply limit if specified and positive
if (limit && limit > 0) {
  displayServices = displayServices.slice(0, limit);
}

// ============================================================================
// COMPUTE GRID CLASSES
// ============================================================================

const gridClasses: Record<2 | 3 | 4, string> = {
  2: 'grid-cols-1 md:grid-cols-2',
  3: 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3',
  4: 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4'
};

const gridClass = gridClasses[columns];
---

<!-- ========================================================================== -->
<!-- TEMPLATE -->
<!-- ========================================================================== -->

<Section padding="lg" class={className}>
  <Container>
    <!-- Heading Section (conditional) -->
    {(heading || subheading) && (
      <div class="text-center mb-12">
        {heading && (
          <h2 class="font-heading text-h2 text-center mb-4">
            {heading}
          </h2>
        )}
        {subheading && (
          <p class="font-body text-body-lg text-gray-600 text-center max-w-3xl mx-auto">
            {subheading}
          </p>
        )}
      </div>
    )}

    <!-- Services Grid or Empty State -->
    {displayServices.length > 0 ? (
      <>
        <!-- Services Grid -->
        <div class={cn('grid gap-6', gridClass)}>
          {displayServices.map((service) => (
            <ServiceCard
              service={service}
              variant={variant}
              linkType={linkType}
              locationSlug={locationSlug}
            />
          ))}
        </div>

        <!-- View All Services Link (conditional) -->
        {showViewAll && (
          <div class="mt-12 text-center">
            <Button variant="outline" size="lg" asChild>
              <a href="/services" class="inline-flex items-center gap-2">
                View All Services
                <ArrowRight className="h-4 w-4" aria-hidden="true" />
              </a>
            </Button>
          </div>
        )}
      </>
    ) : (
      <!-- Empty State -->
      <div class="text-center py-12">
        <p class="text-muted-foreground">No services available at this time.</p>
      </div>
    )}
  </Container>
</Section>
