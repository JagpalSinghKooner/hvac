---
import Section from '@/components/layout/Section.astro';
import Container from '@/components/layout/Container.astro';
import { Accordion, AccordionItem, AccordionTrigger, AccordionContent } from '@/components/ui/accordion';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import PhoneCTA from '@/components/cta/PhoneCTA.astro';
import * as Icons from 'lucide-react';
import type { ServiceProblem } from '@/data/serviceContent';

interface Props {
  problems: ServiceProblem[];           // Required: Array of problems from serviceContent.ts
  heading?: string;                     // Optional: Default "Common Problems We Solve"
  subheading?: string;                  // Optional: Additional context below heading
  variant?: 'accordion' | 'grid';       // Optional: Default 'accordion'
  showCTA?: boolean;                    // Optional: Default true
  ctaText?: string;                     // Optional: Custom CTA text
  class?: string;                       // Optional: Custom wrapper classes
}

const {
  problems,
  heading = 'Common Problems We Solve',
  subheading,
  variant = 'accordion',
  showCTA = true,
  ctaText = 'Experiencing one of these issues? We can help.',
  class: className,
} = Astro.props;

// Early return if no problems provided
if (!problems || problems.length === 0) {
  return null;
}

// Pre-process problems to resolve icon components (Astro compatibility)
const problemsWithIcons = problems.map(problem => ({
  ...problem,
  IconComponent: (Icons as any)[problem.icon] || Icons.AlertTriangle
}));
---

<Section padding="lg" class={`bg-muted/30 ${className || ''}`}>
  <Container size="default">
    <!-- Heading Section -->
    <div class="text-center mb-12">
      <h2 class="text-3xl font-semibold mb-4">{heading}</h2>
      {subheading && (
        <p class="text-lg text-muted-foreground max-w-3xl mx-auto">{subheading}</p>
      )}
    </div>

    <!-- Accordion Variant -->
    {variant === 'accordion' && (
      <Accordion type="single" collapsible className="w-full max-w-4xl mx-auto">
        {problemsWithIcons.map((problem, index) => (
          <AccordionItem value={`problem-${index}`} key={`problem-${index}`}>
            <AccordionTrigger className="text-left font-semibold gap-3">
              <span class="flex items-center gap-3">
                <problem.IconComponent className="h-5 w-5 text-destructive flex-shrink-0" aria-hidden="true" />
                <span>{problem.problem}</span>
              </span>
            </AccordionTrigger>
            <AccordionContent className="text-muted-foreground pl-8">
              {problem.solution}
            </AccordionContent>
          </AccordionItem>
        ))}
      </Accordion>
    )}

    <!-- Grid Variant -->
    {variant === 'grid' && (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {problemsWithIcons.map((problem, index) => (
          <Card className="relative overflow-hidden" key={`problem-grid-${index}`}>
            <CardHeader>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-full bg-destructive/10 flex items-center justify-center flex-shrink-0">
                  <problem.IconComponent className="h-6 w-6 text-destructive" aria-hidden="true" />
                </div>
                <CardTitle className="text-lg">{problem.problem}</CardTitle>
              </div>
            </CardHeader>
            <CardContent>
              <p class="text-muted-foreground">{problem.solution}</p>
            </CardContent>
          </Card>
        ))}
      </div>
    )}

    <!-- PhoneCTA Section -->
    {showCTA && (
      <div class="mt-12 flex flex-col items-center gap-4">
        <p class="text-lg font-semibold text-center">
          {ctaText}
        </p>
        <PhoneCTA variant="hero" class="w-full sm:w-auto" />
      </div>
    )}
  </Container>
</Section>
