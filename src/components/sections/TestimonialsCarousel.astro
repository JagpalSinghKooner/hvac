---
import { getEntry } from 'astro:content';
import Section from '@/components/layout/Section.astro';
import Container from '@/components/layout/Container.astro';
import { Button } from '@/components/ui/button';
import { Star, ExternalLink } from 'lucide-react';
import { TestimonialsCarouselClient } from '@/components/ui/carousel';
import { cn } from '@/lib/utils';
import {
  getTopTestimonials,
  getTestimonialsByLocation,
  getTestimonialsByService,
  type Testimonial
} from '@/data/testimonials';

// ============================================================================
// TYPE DEFINITIONS
// ============================================================================

interface Props {
  // Data Props
  testimonials?: Testimonial[];
  limit?: number;                    // Default: 8
  showVerifiedOnly?: boolean;        // Default: false
  location?: string;                 // Filter by city (e.g., "Guelph")
  service?: string;                  // Filter by service (e.g., "Furnace Repair")

  // Content Props
  heading?: string;                  // Default: "What Our Customers Say"
  subheading?: string;
  showGoogleRating?: boolean;        // Default: true

  // Carousel Behavior
  autoplay?: boolean;                // Default: true
  autoplayInterval?: number;         // Default: 5000ms
  loop?: boolean;                    // Default: true

  // Navigation
  showDots?: boolean;                // Default: true
  showArrows?: boolean;              // Default: true

  // CTA
  showViewAllButton?: boolean;       // Default: true
  viewAllUrl?: string;               // Default: Google Maps URL

  // Styling
  variant?: 'card' | 'quote';        // Default: 'card'
  class?: string;
}

// ============================================================================
// PROPS DESTRUCTURING WITH DEFAULTS
// ============================================================================

const {
  testimonials: providedTestimonials,
  limit = 8,
  showVerifiedOnly = false,
  location,
  service,
  heading = "What Our Customers Say",
  subheading,
  showGoogleRating = true,
  variant = 'card',
  autoplay = true,
  autoplayInterval = 5000,
  loop = true,
  showDots = true,
  showArrows = true,
  showViewAllButton = true,
  viewAllUrl,
  class: className
} = Astro.props;

// ============================================================================
// DATA FETCHING LOGIC
// ============================================================================

let displayTestimonials: Testimonial[];

if (providedTestimonials) {
  displayTestimonials = providedTestimonials;
} else {
  // Auto-fetch logic
  if (location) {
    displayTestimonials = getTestimonialsByLocation(location);
  } else if (service) {
    displayTestimonials = getTestimonialsByService(service);
  } else {
    displayTestimonials = getTopTestimonials(limit);
  }

  // Filter verified if requested
  if (showVerifiedOnly) {
    displayTestimonials = displayTestimonials.filter(t => t.verified === true);
  }

  // Sort by date (newest first)
  displayTestimonials.sort((a, b) =>
    new Date(b.date).getTime() - new Date(a.date).getTime()
  );

  // Apply limit
  if (limit && limit > 0) {
    displayTestimonials = displayTestimonials.slice(0, limit);
  }
}

// Early return if no testimonials
if (!displayTestimonials || displayTestimonials.length === 0) {
  return null;
}

// ============================================================================
// BUSINESS PROFILE INTEGRATION
// ============================================================================

const businessProfile = await getEntry('business', 'profile');
const business = businessProfile?.data as any;
const googleRating = business?.reputation?.google_rating || 4.8;
const reviewCount = business?.reputation?.google_review_count || 407;

// Default Google Maps URL (will be replaced with real URL)
const defaultViewAllUrl = business?.social?.google_maps || "https://www.google.com/maps";
const finalViewAllUrl = viewAllUrl || defaultViewAllUrl;
---

<Section padding="lg" class={cn("bg-muted/30", className)}>
  <Container>
    <!-- Google Rating Header (conditional) -->
    {showGoogleRating && (
      <div class="flex items-center justify-center gap-3 mb-6">
        <div class="flex gap-0.5">
          {[...Array(5)].map(() => (
            <Star className="h-5 w-5 fill-yellow-500 text-yellow-500" />
          ))}
        </div>
        <span class="text-2xl font-bold">{googleRating}</span>
        <span class="text-muted-foreground">({reviewCount} reviews)</span>
      </div>
    )}

    <!-- Heading Section -->
    {(heading || subheading) && (
      <div class="text-center mb-10">
        {heading && <h2 class="font-heading text-h2 text-center mb-4">{heading}</h2>}
        {subheading && (
          <p class="font-body text-body-lg text-gray-600 text-center max-w-3xl mx-auto">{subheading}</p>
        )}
      </div>
    )}

    <!-- React Carousel Component -->
    <TestimonialsCarouselClient
      client:load
      testimonials={displayTestimonials}
      variant={variant}
      autoplay={autoplay}
      autoplayInterval={autoplayInterval}
      loop={loop}
      showDots={showDots}
      showArrows={showArrows}
    />

    <!-- View All Reviews CTA -->
    {showViewAllButton && (
      <div class="mt-12 text-center">
        <Button variant="outline" size="lg" asChild className="hover:shadow-card transition-shadow duration-300 group">
          <a href={finalViewAllUrl} target="_blank" rel="noopener noreferrer">
            View All Reviews on Google
            <ExternalLink className="ml-2 h-4 w-4 transition-transform duration-300 group-hover:translate-x-1" />
          </a>
        </Button>
      </div>
    )}
  </Container>
</Section>
