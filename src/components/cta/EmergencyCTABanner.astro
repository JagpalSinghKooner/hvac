---
import { getEntry } from 'astro:content';
import { Flame } from 'lucide-react';
import PhoneCTA from '@/components/cta/PhoneCTA.astro';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';

interface Props {
  variant?: 'homepage' | 'service' | 'location';
  sticky?: boolean;
  class?: string;
}

const { variant = 'homepage', sticky = false, class: className } = Astro.props;

// Fetch business profile for response time
const businessProfile = await getEntry('business', 'profile');
if (!businessProfile) {
  throw new Error('Business profile not found');
}
const business = businessProfile.data;

// Get response time data
const responseTime = business.hours?.target_response_time_minutes || 60;
const emergencyAvailable = business.hours?.emergency_service || true;

// Early return if emergency service not available
if (!emergencyAvailable) {
  return null;
}

// Variant-specific text configuration
const textConfig = {
  homepage: {
    heading: '24/7 Emergency Service Available',
    subheading: `Response typically within ${responseTime} minutes across our service area`
  },
  service: {
    heading: 'Emergency HVAC Repair Available 24/7',
    subheading: `Fast emergency repairs for all makes and models — typically within ${responseTime} minutes`
  },
  location: {
    heading: 'Emergency Service in Your Area',
    subheading: `Local emergency HVAC technicians available 24/7 — typically within ${responseTime} minutes`
  }
};

const text = textConfig[variant];

// Sticky classes (mobile only)
const stickyClasses = sticky
  ? 'fixed bottom-0 left-0 right-0 z-50 md:relative'
  : 'relative';
---

<section
  class={cn(
    'w-full overflow-hidden py-8 md:py-12 bg-secondary-50',
    stickyClasses,
    className
  )}
  aria-label="Emergency service call-to-action"
>
  <!-- Gradient mesh warm background for urgency -->
  <div class="absolute inset-0 gradient-mesh-warm -z-10 opacity-60"></div>

  <div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row items-center justify-between gap-6 text-center md:text-left">
      <!-- Left: Emergency badge + message -->
      <div class="flex flex-col md:flex-row items-center gap-4">
        <Badge variant="featured" className="animate-pulse-slow shadow-glow-secondary gap-1.5">
          <Flame className="h-3.5 w-3.5" aria-hidden="true" />
          24/7 Emergency
        </Badge>
        <div>
          <h2 class="font-heading text-h2 text-gray-900 mb-1">
            {text.heading}
          </h2>
          <p class="font-body text-body text-gray-700">
            {text.subheading}
          </p>
        </div>
      </div>

      <!-- Right: Phone CTA -->
      <PhoneCTA
        variant="emergency"
        showBadge={false}
        class="flex-shrink-0"
      />
    </div>
  </div>
</section>

<style>
  @media (prefers-reduced-motion: reduce) {
    .animate-pulse-slow {
      animation: none;
    }
  }
</style>
