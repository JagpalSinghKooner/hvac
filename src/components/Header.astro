---
import { getEntry } from 'astro:content';
import { Image } from 'astro:assets';
import Section from '@/components/layout/Section.astro';
import Container from '@/components/layout/Container.astro';
import DesktopNav from '@/components/nav/DesktopNav.astro';
import { MobileNav } from '@/components/nav/MobileNav';
import PhoneCTA from '@/components/cta/PhoneCTA.astro';
import logo from '@/assets/images/bapheatingandcoolingltd.webp';

const businessProfile = await getEntry('business', 'profile');
if (!businessProfile) {
  throw new Error('Business profile not found');
}
const business = businessProfile.data;
---

<Section as="header" padding="none" id="main-header" class="sticky top-0 z-50 bg-background/95 backdrop-blur border-b transition-shadow duration-300">
  <Container>
    <nav class="flex items-center justify-between h-16 md:h-20 gap-4 font-heading" aria-label="Main navigation">
      <!-- Logo -->
      <a
        href="/"
        class="flex items-center shrink-0 transition-transform duration-300 hover:scale-105"
        aria-label={`${business.business.legal_name} - Home`}
      >
        <Image
          src={logo}
          alt={business.business.legal_name}
          width={180}
          height={60}
          class="h-12 md:h-14 w-auto"
          loading="eager"
          decoding="async"
        />
      </a>

      <!-- Desktop Nav (hidden on mobile) -->
      <div class="hidden lg:flex flex-1 justify-center">
        <DesktopNav />
      </div>

      <!-- Actions (Phone CTA + Mobile Menu) -->
      <div class="flex items-center gap-3 shrink-0">
        <!-- Phone CTA (always visible) -->
        <div class="hidden sm:block">
          <PhoneCTA variant="header" />
        </div>

        <!-- Mobile Menu (visible on mobile/tablet only) -->
        <div class="lg:hidden">
          <MobileNav business={business as any} client:load />
        </div>
      </div>
    </nav>
  </Container>
</Section>

<script>
  // Optimized scroll listener with RAF throttling for smooth 60fps performance
  let ticking = false;
  const SCROLL_THRESHOLD = 20;

  function updateHeaderShadow() {
    const header = document.getElementById('main-header');
    if (!header) return;

    if (window.scrollY > SCROLL_THRESHOLD) {
      header.classList.add('shadow-elevated');
    } else {
      header.classList.remove('shadow-elevated');
    }

    ticking = false;
  }

  function onScroll() {
    if (!ticking) {
      window.requestAnimationFrame(updateHeaderShadow);
      ticking = true;
    }
  }

  // Use passive listener for better scroll performance
  window.addEventListener('scroll', onScroll, { passive: true });

  // Initial check on page load
  updateHeaderShadow();
</script>
