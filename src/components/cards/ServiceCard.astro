---
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import * as Icons from 'lucide-react';
import { ArrowRight } from 'lucide-react';
import { cn } from '@/lib/utils';

interface Service {
  title: string;
  slug: string;
  description: string;
  icon?: string; // Lucide icon name (e.g., 'Flame', 'Snowflake', 'Wind')
  category: 'heating' | 'cooling' | 'iaq' | 'water-heating' | 'commercial' | 'plans';
}

interface Props {
  service: Service;
  variant?: 'compact' | 'featured';
  linkType?: 'standard' | 'location-specific';
  locationSlug?: string; // Required when linkType is 'location-specific'
  class?: string;
}

const {
  service,
  variant = 'compact',
  linkType = 'standard',
  locationSlug,
  class: className
} = Astro.props;

// Category to color mapping
const getCategoryColors = (category: Service['category']) => {
  switch (category) {
    case 'heating':
      return {
        bgColor: 'bg-secondary/10',        // Orange/10% for heating
        textColor: 'text-secondary',       // Orange text
        borderColor: 'border-secondary/30',
        badgeVariant: 'secondary' as const
      };
    case 'cooling':
      return {
        bgColor: 'bg-primary/10',          // Blue/10% for cooling
        textColor: 'text-primary',         // Blue text
        borderColor: 'border-primary/30',
        badgeVariant: 'default' as const   // Default badge is primary
      };
    case 'iaq':
    case 'water-heating':
    case 'commercial':
    case 'plans':
    default:
      return {
        bgColor: 'bg-accent/10',           // Neutral accent for other services
        textColor: 'text-accent-foreground',
        borderColor: 'border-accent/30',
        badgeVariant: 'outline' as const
      };
  }
};

// Dynamic icon resolution with fallbacks
const getIconComponent = (iconName?: string, category?: Service['category']) => {
  // If explicit icon provided, try to resolve it
  if (iconName) {
    const IconComponent = (Icons as any)[iconName];
    if (IconComponent) return IconComponent;
  }

  // Fallback to category-specific defaults
  switch (category) {
    case 'heating':
      return Icons.Flame;
    case 'cooling':
      return Icons.Snowflake;
    case 'iaq':
      return Icons.Wind;
    case 'water-heating':
      return Icons.Droplets;
    case 'commercial':
      return Icons.Building2;
    case 'plans':
      return Icons.Calendar;
    default:
      return Icons.Wrench; // Generic service icon
  }
};

// Image URL mapping for featured variant
const getFeaturedImage = (category: Service['category'], title: string) => {
  switch (category) {
    case 'heating':
      return {
        src: 'https://images.unsplash.com/photo-1581094271901-8022df4466f9?w=400&h=300&q=80&fit=crop',
        alt: `${title} - Professional heating services`
      };
    case 'cooling':
      return {
        src: 'https://images.unsplash.com/photo-1631545806609-7d0ae5dd1b8b?w=400&h=300&q=80&fit=crop',
        alt: `${title} - Expert air conditioning services`
      };
    default:
      return {
        src: `https://placehold.co/400x300/0066CC/FFFFFF?text=${encodeURIComponent(title)}`,
        alt: `${title} - HVAC services`
      };
  }
};

// Route URL construction
const getServiceUrl = () => {
  if (linkType === 'location-specific' && locationSlug) {
    return `/services/${service.slug}-${locationSlug}-on`;
  }
  return `/services/${service.slug}`;
};

// Truncate description to 100 characters for compact variant
const getTruncatedDescription = (desc: string, maxLength: number = 100) => {
  if (desc.length <= maxLength) return desc;

  // Find last space before maxLength to avoid cutting words
  const truncated = desc.substring(0, maxLength);
  const lastSpace = truncated.lastIndexOf(' ');

  return lastSpace > 0
    ? truncated.substring(0, lastSpace) + '...'
    : truncated + '...';
};

// Compute values
const colors = getCategoryColors(service.category);
const ServiceIcon = getIconComponent(service.icon, service.category);
const serviceUrl = getServiceUrl();
const displayDescription = variant === 'compact'
  ? getTruncatedDescription(service.description)
  : service.description;
const featuredImage = variant === 'featured' ? getFeaturedImage(service.category, service.title) : null;

// Format category name for badge display
const categoryLabel = service.category === 'iaq'
  ? 'IAQ'
  : service.category.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
---

{variant === 'compact' ? (
  <Card className={cn(
    "h-full flex flex-col group transition-all duration-300 hover:shadow-card-hover service-card",
    className
  )}>
    <CardContent className="p-6 flex flex-col gap-4 flex-1">
      <!-- Icon in gradient ring -->
      <div class={cn(
        "relative w-12 h-12 rounded-full p-0.5 transition-transform duration-300 group-hover:scale-110",
        service.category === 'heating' ? 'gradient-heating' :
        service.category === 'cooling' ? 'gradient-cooling' :
        'gradient-brand'
      )}>
        <div class="w-full h-full bg-white rounded-full flex items-center justify-center">
          <ServiceIcon className={cn("h-6 w-6 transition-transform duration-300 group-hover:rotate-6", colors.textColor)} aria-hidden="true" />
        </div>
      </div>

      <!-- Title (h3 for semantic hierarchy) -->
      <h3 class="text-xl font-semibold leading-tight">
        {service.title}
      </h3>

      <!-- Description (truncated) -->
      <p class="text-sm text-muted-foreground flex-1">
        {displayDescription}
      </p>

      <!-- Learn More link with arrow trail -->
      <a
        href={serviceUrl}
        class={cn(
          "inline-flex items-center gap-2 text-sm font-medium arrow-link transition-all duration-300",
          colors.textColor
        )}
        aria-label={`Learn more about ${service.title}`}
      >
        Learn More
        <ArrowRight className="h-4 w-4 arrow-icon" aria-hidden="true" />
      </a>
    </CardContent>
  </Card>
) : (
  <Card className={cn(
    "h-full flex flex-col overflow-hidden group transition-all duration-300 hover:shadow-card-hover service-card",
    className
  )}>
    <!-- Featured image with gradient overlay -->
    <div class="relative w-full h-48 overflow-hidden">
      <img
        src={featuredImage!.src}
        alt={featuredImage!.alt}
        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 ease-out"
        loading="lazy"
      />
      <!-- Gradient overlay on hover -->
      <div class={cn(
        "absolute inset-0 opacity-0 group-hover:opacity-30 transition-opacity duration-500",
        service.category === 'heating' ? 'bg-gradient-to-br from-secondary-400/50 to-secondary-600/50' :
        service.category === 'cooling' ? 'bg-gradient-to-br from-primary-400/50 to-primary-600/50' :
        'bg-gradient-to-br from-primary-500/50 to-secondary-500/50'
      )}></div>
      <!-- Category badge overlay -->
      <div class="absolute top-4 right-4 z-10">
        <Badge variant={colors.badgeVariant} className="shadow-md backdrop-blur-sm bg-white/90">
          {categoryLabel}
        </Badge>
      </div>
    </div>

    <!-- Content below image (same structure as compact) -->
    <CardContent className="p-6 flex flex-col gap-4 flex-1">
      <!-- Icon in gradient ring -->
      <div class={cn(
        "relative w-12 h-12 rounded-full p-0.5 transition-transform duration-300 group-hover:scale-110",
        service.category === 'heating' ? 'gradient-heating' :
        service.category === 'cooling' ? 'gradient-cooling' :
        'gradient-brand'
      )}>
        <div class="w-full h-full bg-white rounded-full flex items-center justify-center">
          <ServiceIcon className={cn("h-6 w-6 transition-transform duration-300 group-hover:rotate-6", colors.textColor)} aria-hidden="true" />
        </div>
      </div>

      <!-- Title (h3) -->
      <h3 class="text-xl font-semibold leading-tight">
        {service.title}
      </h3>

      <!-- Full description (no truncation) -->
      <p class="text-sm text-muted-foreground flex-1">
        {service.description}
      </p>

      <!-- Learn More link with arrow trail -->
      <a
        href={serviceUrl}
        class={cn(
          "inline-flex items-center gap-2 text-sm font-medium arrow-link transition-all duration-300",
          colors.textColor
        )}
        aria-label={`Learn more about ${service.title}`}
      >
        Learn More
        <ArrowRight className="h-4 w-4 arrow-icon" aria-hidden="true" />
      </a>
    </CardContent>
  </Card>
)}

<style>
  .service-card {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .service-card:hover {
    transform: translateY(-8px) rotate(-1deg);
  }

  .arrow-link {
    position: relative;
  }

  .arrow-icon {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .arrow-link:hover .arrow-icon {
    transform: translateX(6px);
  }

  /* Trail effect */
  .arrow-link::after {
    content: 'â†’';
    position: absolute;
    right: 0;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: currentColor;
    font-size: 1rem;
    pointer-events: none;
  }

  .arrow-link:hover::after {
    right: 12px;
    opacity: 0.25;
  }

  @media (prefers-reduced-motion: reduce) {
    .service-card:hover {
      transform: translateY(-4px);
      /* No rotation for reduced motion */
    }

    .arrow-link::after {
      display: none;
    }
  }
</style>
