---
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Star, CheckCircle } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { Testimonial } from '@/data/testimonials';

interface Props {
  testimonial: Testimonial;
  variant?: 'card' | 'quote';
  class?: string;
}

const { testimonial, variant = 'card', class: className } = Astro.props;

// Defensive defaults for edge cases
const rating = testimonial.rating || 5;
const authorName = testimonial.author || 'Anonymous';
const location = testimonial.location || 'Southern Ontario';
const service = testimonial.service || 'HVAC Service';
const hasText = testimonial.text && testimonial.text.trim().length > 0;

// Star rating calculation
const filledStars = rating;
const emptyStars = 5 - rating;
---

{variant === 'card' ? (
  <Card className={cn("h-full flex flex-col", className)}>
    <CardContent className="p-6 flex flex-col gap-4 flex-1">
      <!-- Gradient quote icon and star rating -->
      <div class="flex items-start justify-between gap-4 mb-4">
        <!-- Gradient quote icon -->
        <div class="w-10 h-10 rounded-full gradient-brand p-0.5 flex-shrink-0">
          <div class="w-full h-full bg-white rounded-full flex items-center justify-center">
            <svg
              class="h-5 w-5 text-primary"
              fill="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z" />
            </svg>
          </div>
        </div>

        <!-- Star Rating with ARIA -->
        <div
          class="flex gap-0.5"
          role="img"
          aria-label={`${rating} out of 5 stars`}
        >
          {[...Array(filledStars)].map((_, index) => (
            <Star
              className="h-4 w-4 text-secondary star-filled"
              style={{ animationDelay: `${index * 100}ms` }}
            />
          ))}
          {[...Array(emptyStars)].map(() => (
            <Star className="h-4 w-4 text-muted-foreground/30" />
          ))}
        </div>
      </div>

      <!-- Quote Text -->
      {hasText ? (
        <blockquote class="text-sm text-muted-foreground line-clamp-4 flex-1">
          "{testimonial.text}"
        </blockquote>
      ) : (
        <p class="text-sm text-muted-foreground italic flex-1">
          No review text available
        </p>
      )}

      <!-- Author & Badges Footer -->
      <div class="flex flex-col gap-3 pt-2 border-t">
        <div>
          <p class="font-semibold text-sm">{authorName}</p>
          <p class="text-xs text-muted-foreground">{location}</p>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <Badge variant="outline" className="border-primary/30 text-primary truncate max-w-[200px]">
            {service}
          </Badge>
          {testimonial.verified === true && (
            <Badge variant="default" className="flex items-center gap-1">
              <CheckCircle className="h-3 w-3" aria-hidden="true" />
              <span>Verified</span>
            </Badge>
          )}
        </div>
      </div>
    </CardContent>
  </Card>
) : (
  <!-- Quote Variant with gradient icon -->
  <blockquote class={cn("relative border-l-4 border-primary pl-6 py-4 bg-gradient-to-r from-primary-50/30 to-transparent rounded-r-lg", className)}>
    <!-- Gradient quote icon overlapping border -->
    <div class="absolute -left-6 top-4 w-12 h-12 rounded-full gradient-brand p-0.5">
      <div class="w-full h-full bg-white rounded-full flex items-center justify-center">
        <svg
          class="h-5 w-5 text-primary"
          fill="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z" />
        </svg>
      </div>
    </div>

    {hasText ? (
      <p class="text-lg italic text-foreground mb-4 relative z-10">
        "{testimonial.text}"
      </p>
    ) : (
      <p class="text-lg italic text-muted-foreground mb-4">
        No review available
      </p>
    )}
    <footer class="flex items-center gap-2 flex-wrap">
      <div
        class="flex gap-0.5"
        role="img"
        aria-label={`${rating} out of 5 stars`}
      >
        {[...Array(filledStars)].map((_, index) => (
          <Star
            className="h-4 w-4 text-secondary star-filled"
            style={{ animationDelay: `${index * 100}ms` }}
          />
        ))}
        {[...Array(emptyStars)].map(() => (
          <Star className="h-4 w-4 text-muted-foreground/30" />
        ))}
      </div>
      <span class="text-sm font-semibold">â€” {authorName}</span>
      <span class="text-sm text-muted-foreground">{location}</span>
    </footer>
  </blockquote>
)}

<style>
  .star-filled {
    fill: hsl(var(--secondary-500));
    animation: starPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    transform: scale(0);
  }

  @keyframes starPop {
    0% {
      transform: scale(0) rotate(-180deg);
    }
    100% {
      transform: scale(1) rotate(0deg);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .star-filled {
      animation: none;
      transform: scale(1);
    }
  }
</style>
