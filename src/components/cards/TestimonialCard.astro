---
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Star, CheckCircle } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { Testimonial } from '@/data/testimonials';

interface Props {
  testimonial: Testimonial;
  variant?: 'card' | 'quote';
  class?: string;
}

const { testimonial, variant = 'card', class: className } = Astro.props;

// Defensive defaults for edge cases
const rating = testimonial.rating || 5;
const authorName = testimonial.author || 'Anonymous';
const location = testimonial.location || 'Southern Ontario';
const service = testimonial.service || 'HVAC Service';
const hasText = testimonial.text && testimonial.text.trim().length > 0;

// Star rating calculation
const filledStars = rating;
const emptyStars = 5 - rating;
---

{variant === 'card' ? (
  <Card className={cn("h-full flex flex-col", className)}>
    <CardContent className="p-6 flex flex-col gap-4 flex-1">
      <!-- Star Rating with ARIA -->
      <div
        class="flex gap-0.5"
        role="img"
        aria-label={`${rating} out of 5 stars`}
      >
        {[...Array(filledStars)].map(() => (
          <Star className="h-4 w-4 fill-secondary text-secondary" />
        ))}
        {[...Array(emptyStars)].map(() => (
          <Star className="h-4 w-4 text-muted-foreground/30" />
        ))}
      </div>

      <!-- Quote Text -->
      {hasText ? (
        <blockquote class="text-sm text-muted-foreground line-clamp-4 flex-1">
          "{testimonial.text}"
        </blockquote>
      ) : (
        <p class="text-sm text-muted-foreground italic flex-1">
          No review text available
        </p>
      )}

      <!-- Author & Badges Footer -->
      <div class="flex flex-col gap-3 pt-2 border-t">
        <div>
          <p class="font-semibold text-sm">{authorName}</p>
          <p class="text-xs text-muted-foreground">{location}</p>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <Badge variant="outline" className="border-primary/30 text-primary truncate max-w-[200px]">
            {service}
          </Badge>
          {testimonial.verified === true && (
            <Badge variant="default" className="flex items-center gap-1">
              <CheckCircle className="h-3 w-3" aria-hidden="true" />
              <span>Verified</span>
            </Badge>
          )}
        </div>
      </div>
    </CardContent>
  </Card>
) : (
  <!-- Quote Variant -->
  <blockquote class={cn("border-l-4 border-primary pl-6 py-4", className)}>
    {hasText ? (
      <p class="text-lg italic text-foreground mb-4">
        "{testimonial.text}"
      </p>
    ) : (
      <p class="text-lg italic text-muted-foreground mb-4">
        No review available
      </p>
    )}
    <footer class="flex items-center gap-2 flex-wrap">
      <div
        class="flex gap-0.5"
        role="img"
        aria-label={`${rating} out of 5 stars`}
      >
        {[...Array(filledStars)].map(() => (
          <Star className="h-4 w-4 fill-secondary text-secondary" />
        ))}
        {[...Array(emptyStars)].map(() => (
          <Star className="h-4 w-4 text-muted-foreground/30" />
        ))}
      </div>
      <span class="text-sm font-semibold">â€” {authorName}</span>
      <span class="text-sm text-muted-foreground">{location}</span>
    </footer>
  </blockquote>
)}
